import os
import shutil
import hashlib
import platform

# ==== НАСТРОЙКИ ====

# Папка программы
PROGRAM_DIR = "/path/to/your/program"        # заменишь на свой путь
MAIN_FILE = "main.bin"                       # основной файл (exe, bin, py и т.п.)

# Папки, которые надо удалить вместе с программой
RELATED_FOLDERS = [
    "/path/to/AllSync",
    "/path/to/OtherFolder"
]

# Где хранить контрольный хеш (в скрытой системной папке)
HASH_STORAGE = os.path.expanduser("~/.allsync_hash")

# ==== ФУНКЦИИ ====

def get_file_hash(path):
    """Возвращает SHA‑256 хеш файла."""
    h = hashlib.sha256()
    with open(path, "rb") as f:
        h.update(f.read())
    return h.hexdigest()

def delete_path(path):
    """Удаление файлов/папок на всех ОС."""
    if not os.path.exists(path):
        return
    if os.path.isfile(path):
        os.remove(path)
    else:
        shutil.rmtree(path, ignore_errors=True)

# ==== ОСНОВНАЯ ЛОГИКА ====

main_path = os.path.join(PROGRAM_DIR, MAIN_FILE)

if not os.path.exists(main_path):
    print("Программа не найдена, выходим.")
    exit()

# Первый запуск — сохраняем хеш
if not os.path.exists(HASH_STORAGE):
    h = get_file_hash(main_path)
    with open(HASH_STORAGE, "w") as f:
        f.write(h)
    print("Хеш сохранён. Программа зарегистрирована.")
    exit()

# Читаем сохранённый хеш
with open(HASH_STORAGE, "r") as f:
    original_hash = f.read().strip()

current_hash = get_file_hash(main_path)

# Проверяем изменение или перенос
if current_hash != original_hash:
    print("⚠ Обнаружено перемещение или изменение программы! Удаляю...")

    # Удаление самой программы
    delete_path(PROGRAM_DIR)

    # Удаление связанных папок
    for folder in RELATED_FOLDERS:
        delete_path(folder)

    # Удаляем информацию о хеше
    delete_path(HASH_STORAGE)

    print("✔ Программа и связанные данные удалены.")
else:
    print("Все ок, программа не перемещена.")
